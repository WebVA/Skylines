{% extends "base-fullscreen.jinja" %}
{% set active_page = "flights" %}
{% set use_ember = true %}


{% from 'flights/meta-tags.jinja' import flight_meta_tags with context %}
{% from 'flights/macros.jinja' import flight_title with context %}


{% block title -%}{{ flight_title(flight) }}{%- endblock %}


{%- block head %}
{{ super() }}
{{ flight_meta_tags(flight) }}
{%- endblock %}


{%- block styles %}
{{ super() }}

{% assets 'openlayers_css' -%}
<link href="{{ ASSET_URL }}" rel="stylesheet" type="text/css" />
{%- endassets %}
{%- endblock %}


{%- block scripts %}
{{ super() }}

{% assets 'openlayers_js' -%}
<script type="text/javascript" src="{{ ASSET_URL }}"></script>
{%- endassets %}

<script type="text/javascript">
  $(function() {
    var flight_display = null;
    var sidebar = $('#sidebar').sidebar();

    $("#barogram_panel").resize(function() {
      var height = $("#barogram_panel").height() + 10;
      sidebar.css('bottom', height);
      $(".ol-scale-line").css('bottom', height);
      $(".ol-attribution").css('bottom', height);
    });

    window.wingmanTable.on('select', function(sfid) {
      if (!flight_display) return;

      var flights = window.fixCalcService.get('flights');
      var matches = flights.filterBy('id', sfid);
      if (matches.length !== 0) {
        flights.removeObjects(matches);
        window.pinnedFlightsService.unpin(sfid);
      } else {
        window.fixCalcService.addFlightFromJSON("/flights/" + sfid + "/json");
        window.pinnedFlightsService.pin(sfid);
      }
    });

    var url = getShareUrl('{{ request.url }}');
    var content =
        '<div style="text-align:center">' +
        '<input value="' + url + '" type="text" class="form-control" style="margin-bottom:9px">' +
        '<a href="https://www.facebook.com/share.php?u=' + url + '" target="_blank" class="btn btn-default btn-xs"><i class="icon-facebook"> Share</i></a> ' +
        '<a href="https://plus.google.com/share?url=' + url + '" target="_blank" class="btn btn-default btn-xs"><i class="icon-google-plus"> Share</i></a> ' +
        '<a href="https://twitter.com/share?url=' + url + '" target="_blank" class="btn btn-default btn-xs"><i class="icon-twitter"> Tweet</i></a> ' +
        '</div>';

    var popover_template = '<div class="popover" style="white-space: nowrap; z-index: 5000;">' +
                             '<div class="arrow"></div>' +
                             '<h3 class="popover-title"></h3>' +
                             '<div class="popover-content"></div>' +
                           '</div>';

    $(".btn-share").popover({
      trigger: 'click',
      container: '#fullscreen-content',
      content: content,
      title: '{{ _('Spread the word') }}',
      placement: 'bottom',
      html: true,
      template: popover_template
    });

    var map = window.flightMap.get('map');

    var slFlightDisplay = require('skylines/utils/flight-display').default;
    var slMapClickHandler = require('skylines/utils/map-click-handler').default;

    flight_display = slFlightDisplay.create({
      fixCalc: window.fixCalcService,
      flightMap: window.flightMap,
      fix_table: window.fixTable,
      baro: window.barogram
    });
    window.fixCalcService.addFlightFromJSON("/flights/{{ flight.id }}/json?{{ config.get('SKYLINES_CACHE_BUSTER', '') }}",false);

    {% if other_flights -%}
    {% for flight in other_flights -%}
    window.fixCalcService.addFlightFromJSON("/flights/{{ flight.id }}/json?{{ config.get('SKYLINES_CACHE_BUSTER', '') }}");
    {%- endfor %}
    {%- endif %}

    var getPadding = function() { return [20, 20, $("#barogram_panel").height() + 20, sidebar.width() + 20]; };
    window.paddingFn = getPadding;

    var extent = window.fixCalcService.get('flights').getBounds();
    map.getView().fit(extent, map.getSize(), {padding: getPadding()});

    window.pinnedFlightsService.get('pinned').filter(function(id) {
      return id !== {{ flight.id }};
    }).forEach(function(id) {
      window.fixCalcService.addFlightFromJSON("/flights/" + id + "/json");
    });

    slMapClickHandler(map, flight_display, {
      flight_info: true,
      location_info: true,
      api_url: "{{ config.get('SKYLINES_API_URL') }}"
    });

    if (window.location.hash &&
        sidebar.find('li > a[href="#' + window.location.hash.substring(1) + '"]').length != 0) {
      sidebar.open(window.location.hash.substring(1));
    }
  });
</script>
{%- endblock %}


{%- block content %}
<div id="fullscreen-content" class="olFullscreen">
<div id="sidebar" class="sidebar">
<!-- Nav tabs -->
  <ul class="sidebar-tabs" role="tablist">
    <li class="active">
      <a href="#tab-overview" title="{{ _('Overview') }}" role="tab">
        <i class="icon-info icon-large"></i>
      </a>
    </li>
    <li>
      <a href="#tab-comments" title="{{ _('Comments') }}" role="tab">
        <i class="icon-comments-alt icon-large"></i>
        {% if flight.comments[0] -%}
        ({{ flight.comments|count }})
        {%- endif %}
      </a>
    </li>
    <li>
      <a href="#tab-stats-total" title="{{ _('Total') }}" role="tab">
        <i class="icon-bar-chart icon-large"></i> {% trans %}Total{% endtrans %}
      </a>
    </li>
    <li>
      <a href="#tab-stats-legs" title="{{ _('Leg Statistics') }}" role="tab">
        <i class="icon-resize-horizontal icon-large"></i> {% trans %}Legs{% endtrans %}
      </a>
    </li>

    {%- if flight.has_phases %}
    <li>
      <a href="#tab-stats-phases" title="{{ _('Phase Statistics') }}" role="tab">
        <i class="icon-step-forward icon-large"></i> {% trans %}Phase Statistics{% endtrans %}
      </a>
    </li>
    {%- endif %}

    <li>
      <a href="#tab-wingmen" title="{{ _('Wingmen') }}" role="tab">
        <i class="icon-group icon-large"></i>
      </a>
    </li>
  </ul>
<!-- Tab panes -->
  <div class="sidebar-content">
    <div class="sidebar-pane active" id="tab-overview">
      <h3>{% trans %}Overview{% endtrans %}
        <a href="#" class="btn btn-default btn-share btn-sm pull-right" style="margin-top: 5px; margin-right: 28px;">
          <i class="icon-share-alt icon-small"></i> Share
        </a>
      </h3>
      <div class="sidebar-pane-content">
        <div data-component="flight-details-table" data-attrs='{
          "flight": {{ flight_json|tojson }}
        }'>Loading...</div>
      </div>
    </div>
    <div class="sidebar-pane" id="tab-comments">
      <h3><i class="icon-comments-alt"></i> {% trans %}Comments{% endtrans %}</h3>
      <div class="sidebar-pane-content">
        <div data-component='comments-list' data-attrs='{
          "comments":{{ comments|tojson }}
        }'></div>
      </div>
    </div>
    <div class="sidebar-pane" id="tab-stats-total">
      <h3>{% trans %}Statistics{% endtrans %}</h3>
      <div class="sidebar-pane-content">
        <h4>{% trans %}Circling performance{% endtrans %}</h4>
        <div data-component='circling-performance-table' data-attrs='{
          "perf": {{ circling_performance|tojson }}
        }'></div>

        <h4>{% trans %}Cruise performance{% endtrans %}</h4>
        <div data-component='cruise-performance-table' data-attrs='{
          "perf": {{ cruise_performance|tojson }}
        }'></div>
      </div>
    </div>
    <div class="sidebar-pane" id="tab-stats-legs">
      <h3>{% trans %}Legs{% endtrans %}</h3>
      <div class="sidebar-pane-content" data-component='flight-leg-panel' data-attrs='{
        "legs": {{ contest_legs|tojson }}
      }'></div>
    </div>

    {%- if flight.has_phases %}
    <div class="sidebar-pane" id="tab-stats-phases">
      <h3>{% trans %}Phase Statistics{% endtrans %}</h3>
      <div class="sidebar-pane-content">
        <div class="table-responsive">
          <div data-component='flight-phase-table' data-attrs='{
            "phases": {{ phases|tojson }}
          }'></div>
        </div>
      </div>
    </div>
    {%- endif %}

    <div class="sidebar-pane" id="tab-wingmen">
      <h3>{% trans %}Wingmen{% endtrans %}</h3>
      <div class="sidebar-pane-content">
        <div data-component='wingman-table' data-attrs='{"nearFlights": {{ near_flights|tojson }}}'></div>
      </div>
    </div>
  </div>
</div>

<div data-component='flight-map' data-attrs='{
  "fullscreenElement": "#fullscreen-content",
  "bingAPIKey": "{{ config.get('SKYLINES_BING_API_KEY', 'null') }}",
  "mapboxAPIKey": "{{ config.get('SKYLINES_MAPBOX_API_KEY', 'null') }}",
  "mapTileURL": "{{ config.get('SKYLINES_MAP_TILE_URL') }}"
}' class="olFullscreen sidebar-map"></div>
<div id="barogram_panel" class="map-bottom-panel map-overlay">
    <div style="overflow: auto; max-height: 115px">
        <div data-component='fix-table'></div>
    </div>
    <div data-component='flight-barogram'></div>
</div>

<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-hidden="true" style="display:none"></div>
</div>
{%- endblock %}
