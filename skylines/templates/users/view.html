<?python
from babel.numbers import format_number
from babel.dates import format_date

title = user.display_name

def add_marker(location):
  template = '''
        vectorLayer.addFeatures(new OpenLayers.Feature.Vector(
          new OpenLayers.Geometry.Point({},{}).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
          {{}}, {{externalGraphic: "/images/OpenLayers/marker.png", graphicHeight: 21, graphicWidth: 16}}
        ));'''
  return template.format(location.longitude, location.latitude)

def add_takeoff_location_markers(takeoff_locations):
  output = []
  for takeoff_location in takeoff_locations:
    if takeoff_location:
      output.append(add_marker(takeoff_location))

  return '\n'.join(output)
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">

  <xi:include href="master/page.html" />

  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" py:if="False"/>

    <link href="/css/OpenLayers.css" rel="stylesheet" type="text/css" />
    <link href="/css/SimpleLayerSwitcher.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="/js/OpenLayers/OpenLayers.js"></script>
    <script type="text/javascript" src="/js/OpenLayers/SimpleLayerSwitcher.js"></script>
    <script type="text/javascript" src="/js/map.js"></script>
    <script type="text/javascript" src="/static/jquery/jquery.timeago.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap-tooltip.js"></script>

    <script type="text/javascript">
      /* <![CDATA[ */
      $(function() {
        initOpenLayers("map_canvas");

        $.getScript("http://maps.google.com/maps/api/js?v=3.7&sensor=false&callback=addGoogleLayer");
        addBingLayers("${config.get('skylines.bing.api_key', 'null')}");

        $("abbr.timeago").timeago();
        $("[rel=tooltip]").tooltip();

        var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
        map.addLayer(vectorLayer);

        ${add_takeoff_location_markers(takeoff_locations)}

        map.zoomToExtent(vectorLayer.getDataExtent().scale(1.1));
        var zoom = map.getZoom();
        if (zoom > 10)
          map.zoomTo(10);
      });
      /* ]]> */
    </script>
  </head>

  <body itemscope="" itemtype="http://schema.org/Person">
    <meta itemprop="url" content="/users/${user.user_id}" />
    <div class="row">
      <div class="well span8 offset2">
        <table class="right">
          <tr py:if="user.is_readable()">
            <th>Login name</th>
            <td py:content="user.user_name">Foo</td>
          </tr>

          <tr py:if="user.is_readable()">
            <th>Email</th>
            <td py:content="user.email_address" itemprop="email">Foo</td>
          </tr>

          <tr>
            <th>Display name</th>
            <td py:content="user.display_name" itemprop="name">Foo</td>
          </tr>

          <tr py:if="user.is_readable() and user.tracking_key_hex is not None">
            <th>Tracking key</th>
            <td>
              <span class="label label-info" py:content="user.tracking_key_hex">Tracking Key</span>
            </td>
          </tr>

          <tr py:if="user.club">
            <th>Club</th>
            <td itemprop="memberof" itemscope="" itemtype="http://schema.org/SportsTeam">
              <meta itemprop="url" content="/clubs/${user.club_id}" />
              <a href="/clubs/${user.club_id}/" py:content="user.club" itemprop="name">
                Foo
              </a>
            </td>
          </tr>
        </table>

        <p py:if="user.is_writable()">
          <a href="/users/${user.user_id}/edit" class="btn">Edit</a>
        </p>

        <py:if test="distance_flights">
          <h2>Distance Flights</h2>
          <table>
            <thead>
              <tr>
                <th>Distance</th>
                <th>Date</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr py:for="distance_flight in distance_flights">
                <td py:content="format_number(distance_flight[0]) + ' km'">300 km</td>
                <td>
                  <abbr py:if="distance_flight[1]" class="timeago"
                        title="${distance_flight[1].landing_time.isoformat()}"
                        py:content="format_date(distance_flight[1].landing_time)"
                        rel="tooltip">4 days ago</abbr>
                </td>
                <td>
                  <a py:if="distance_flight[1]"
                     href="/flights/${distance_flight[1].id}">Show</a>
                </td>
              </tr>
            </tbody>
          </table>
        </py:if>
      </div>

      <div class="span12">
        <h2>Takeoff Locations</h2>
        <div id="map_canvas" style="width:100%; height:400pt;"></div>
      </div>
    </div>
  </body>
</html>
