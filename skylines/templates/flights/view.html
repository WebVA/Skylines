<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">

  <xi:include href="master/page.html" />

<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" py:if="False"/>

  <link href="/css/OpenLayers.css" rel="stylesheet" type="text/css" />

  <script type="text/javascript" src="/js/OpenLayers/OpenLayers.js"></script>
  <script type="text/javascript" src="/js/OpenLayers/map.js"></script>

  <script type="text/javascript" src="/js/g.raphael/raphael-min.js"></script>
  <script type="text/javascript" src="/js/g.raphael/g.raphael-min.js"></script>
  <script type="text/javascript" src="/js/g.raphael/g.line-min.js"></script>
  <script type="text/javascript">
<?python from simplejson import dumps ?>
    /* <![CDATA[ */

    var barograph;

    function render_barograph() {
      var element = document.getElementById("barograph");
      barograph.linechart(30, 0,
                          element.clientWidth - 40, element.clientHeight,
                          ${dumps(barograph_t)},
                          [${dumps(barograph_h)}],
                          { axis: "0 0 0 1" }).hoverColumn(function() {
          this.position = barograph.set();

          var line = barograph.path(
            "M " + this.x.toString() + " " + this.attrs.height + " " +
            "l 0 " + (-(this.attrs.height - this.y) + 6).toString() +
            "M " + this.x.toString() + " 0 " +
            "l 0 " + (this.y - 6).toString()
          ).attr({
            stroke: '#c44',
            'stroke-width': 2
          });
          this.position.push(line.insertBefore(this));

          var vario = null;
          if (this.next) {
            vario = (this.next.values[0] - this.values[0]) / (this.next.axis - this.axis);
          }

          var text = barograph.text(
            this.x,
            this.attrs.height - 20,
            Math.round(this.values[0]) + " m" +
              ((vario !== null)?"\n" + (Math.round(vario*10)/10) + " m/s":"")
          );

          var textBBox = text.getBBox();

          this.position.push(barograph.circle(
            this.x,
            this.y,
            6
          ).insertBefore(this).attr({ stroke: '#c44', 'stroke-width': 2 }));

          this.position.push(barograph.rect(
            textBBox.x - 2,
            textBBox.y - 2,
            textBBox.width + 4,
            textBBox.height + 4,
            3
          ).insertBefore(this).attr({
            fill: '#fff',
            opacity: .7,
            stroke: '#999'
          }) );

          this.position.push(text.insertBefore(this));
        }, function() {
          this.position && this.position.remove();
      });
    }


    function initialize() {
      var map = initOpenLayers();

      var lonlat = OpenLayers.Util.decodeGooglePolyline(${dumps(fixes.points)});
      var lod = OpenLayers.Util.decodeGoogleLoD(${dumps(fixes.levels)}, ${fixes.numLevels});

      var points = new Array();
      for (var i = 0, len = lonlat.length; i < len; i++) {
        points.push(new OpenLayers.Geometry.Point(lonlat[i].lon, lonlat[i].lat).
          transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()) );
      }

      var flight = new OpenLayers.Geometry.ProgressiveLineString(points, lod, [0, 5, 10, 13]);
      map.getLayersByName("Flight")[0].addFeatures(new OpenLayers.Feature.Vector(flight, { color: '#ff0000' }));

      map.zoomToExtent(flight.bounds);

      barograph = Raphael("barograph", "100%", "100%");
      render_barograph();
    }
    /* ]]> */
  </script>

  <title>View Flight</title>
</head>

  <?python from babel.dates import format_date, format_time, format_datetime ?>

  <body onload="initialize();">
    <div class="row">
      <div class="span4">
        <table class="table">
          <tbody>
            <tr>
              <th>Date</th>
              <td>
                <span py:if="flight.takeoff_time" py:replace="format_date(flight.takeoff_time)">
                  2012-05-21
                </span>
              </td>
            </tr>
            <tr>
              <th>Take-off</th>
              <td>
                <span py:if="flight.takeoff_time" py:replace="format_time(flight.takeoff_time)">
                  10:00
                </span>
              </td>
            </tr>
            <tr>
              <th>Landing</th>
              <td>
                <span py:if="flight.landing_time" py:replace="format_time(flight.landing_time)">
                  15:00
                </span>
              </td>
            </tr>
            <tr>
              <th>Score</th>
              <td>
                ${flight.olc_plus_score} pt
                <span py:if="flight.olc_classic_distance is not None">
                  (${flight.olc_classic_distance/1000} km,
                </span>
                <span py:if="flight.olc_triangle_distance is not None">
                  triangle ${flight.olc_triangle_distance/1000} km)
                </span>
              </td>
            </tr>
            <tr>
              <th>Pilot</th>
              <td>
                <a py:if="flight.pilot" py:content="flight.pilot" href="/flights/pilot/${flight.pilot_id}">
                  Pilot Name
                </a>
                <br py:if="flight.pilot and flight.co_pilot"/>
                <a py:if="flight.co_pilot" py:content="flight.co_pilot" href="/flights/pilot/${flight.co_pilot_id}">
                  Co-Pilot Name
                </a>
                <span py:if="not flight.pilot and not flight.co_pilot" py:strip="True">
                  [unspecified]
                </span>
                <a py:if="flight.is_writable()" href="change_pilot" class="btn">Change</a>
              </td>
            </tr>
            <tr>
              <th>Club</th>
              <td>
                <a py:if="flight.club" py:content="flight.club" href="/flights/club/${flight.club_id}">
                  Club Name
                </a>
              </td>
            </tr>
            <tr>
              <th>Uploaded</th>
              <td>
                ${format_datetime(flight.time_created)} by ${flight.owner}
              </td>
            </tr>
            <tr>
              <th>Download</th>
              <td>
                <a href="${flight.get_download_uri()}" py:content="flight.filename">FOO.IGC</a>
              </td>
            </tr>
            <tr py:if="flight.may_delete()">
              <th>Actions</th>
              <td>
                <a href="delete" class="btn btn-mini">Delete</a>
              </td>
            </tr>
          </tbody>
        </table>

        <p>
          <a href="map" class="btn">Full-screen map</a>
        </p>
      </div>
      <div class="span8">
        <div id="map_canvas" style="width:100%; height:400pt;"></div>
        <div id="barograph" style="width:100%; height:120pt;"></div>
      </div>
    </div>
  </body>
</html>
